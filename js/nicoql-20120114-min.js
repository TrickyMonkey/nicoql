function itemFnButtons(a){var b=document;var c=$(b.createElement("a")).addClass("mark_button");if(localStorage.getItem(a)===null){c=c.text("☆").click(function(){mark(a)})}else{c=c.text("★").click(function(){unmark(a)})}return $(b.createElement("div")).addClass("fn_buttons").append($(b.createElement("a")).text("詳細").click(function(){previewMovieDetail(a)})).append($(b.createElement("a")).attr("href","http://nicosound.anyap.info/sound/"+a).text("にこさうんど")).append($(b.createElement("a")).attr("href","http://dic.nicovideo.jp/v/"+a).text("大百科")).append(c)}function itemHeader(a,b){var c=document;return $(c.createElement("div")).addClass("movie_title").hover(function(a){if(window.innerHeight-a.pageY<200){$(this).siblings(":last").css("top","20px").show()}else{$(this).siblings(":last").css("bottom","20px").show()}},function(){$(this).siblings(":last").removeAttr("style").hide()}).append($(c.createElement("a")).attr("href",b).text(a)).append($(c.createElement("a")).attr({"class":"blank",href:b,target:"_blank"}).text("[別窓表示]"))}function frameBodyItem(a,b,c){var d=document;var e=b.split("/").pop();var f=$(d.createElement("div")).addClass("popup").html(c).hide();return $(d.createElement("li")).attr({"class":"ranking-item",title:e}).append(f.find(".nico-thumbnail")).append(itemHeader(a,b)).append(itemFnButtons(e)).append(f.find(".nico-info-length")).append(f)}function frameBody(a){var b=document;var c=$(b.createElement("ol"));for(var d=-1,e=a.length;++d<e;){var f=$(a[d]);var g=f.find("title").text();var h=f.find("link").text();var i=f.find("description").text();c.append(frameBodyItem(g,h,i))}return c}function frameHeader(a,b,c){var d=document;var e=$(d.createElement("h1")).append($(d.createElement("a")).attr("href",b).text(a));var f=$(d.createElement("span")).addClass("close").click(function(a){c=c.replace(/([ \@#;&,.%+*~\':"!^$[\]()=>|\/])/g,"\\$1");$("."+c).remove();save()});return $(d.createElement("header")).append(e).append(f)}function frame(a){var b=document;var c=makeRID(a);var d=makeRankingTitle(a);var e=makeRankingURL(a);stackRanking(c,d);return $(b.createElement("section")).attr({id:c,"class":c}).append(frameHeader(d,e,c)).append('<p class="loading">読み込み中...</p>')}function insertFrame(a){var b=frame(a);$("#rink").children().each(function(){if(b.attr("id")>=this.id){$(this).before(b);return false}else if($(this).is(":last")){$("#rink").append(b)}});return b}function displayBookmark(){var a=$("#marked_list");a.empty();var b=$("#bookmark_selector option:selected").val();var c=loadBookmark(b);for(var d=-1,e=c.length;++d<e;){var f=c[d];if(f==="")continue;var g=localStorage.getItem(f);if(g===null){continue}var h=g.split("+");a.append(frameMarkedItem(f,h[0],h[1],b))}return false}function importBookmark(){var a=localStorage.getItem("markedMovies");if(a!==null){var b=$("#bookmark_selector option:selected").val();localStorage.setItem(b,a);localStorage.removeItem("markedMovies")}return false}function loadBookmark(a){var b=localStorage.getItem(a);return b===null?[]:b.split("+")}function moveMark(a,b){var c=$("#bookmark_selector option:selected").val();var d=localStorage.getItem(c);var e=d===null?[]:d.split("+");var f=$.inArray(a,e);if(f==-1){return false}e.splice(f,1);localStorage.setItem(c,e.join("+"));var d=localStorage.getItem(b);var g=d===null?[]:d.split("+");g.push(a);localStorage.setItem(b,g.join("+"));$("#bookmark_selector").val(b);displayBookmark();return true}function frameMarkedItem(a,b,c,d){var e=document;var f="http://www.nicovideo.jp/watch/"+a;var g=$(e.createElement("p")).addClass("nico-thumbnail").append($(e.createElement("img")).attr({alt:b,src:c,width:94,height:70,border:0}));var h=$(e.createElement("div")).addClass("movie_title").append($(e.createElement("a")).attr("href",f).text(b)).append($(e.createElement("a")).attr({"class":"blank",href:f,target:"_blank"}).text("[別窓表示]"));var i=$('<label class="bsl" for="bs">移動先:</label><select class="bs">'+'<option value="mark_group0">未分類</option>'+'<option value="mark_group1">グループA</option>'+'<option value="mark_group2">グループB</option>'+'<option value="mark_group3">グループC</option></select>').val(d).change(function(){moveMark(a,$(this).children(":selected").val())});return $(e.createElement("li")).attr({"class":"marked-item",title:a}).append(g).append(h).append(itemFnButtons(a)).append(i)}function unmark(a){$("#bookmark_selector option").each(function(){var b=$(this).val();var c=localStorage.getItem(b);var d=c===null?[]:c.split("+");var e=$.inArray(a,d);if(e==-1){return true}d.splice(e,1);localStorage.removeItem(a);localStorage.setItem(b,d.join("+"))});$("#marked_list li.marked-item[title='"+a+"']").remove();$("li[title='"+a+"'] a.mark_button").each(function(){$(this).text("☆").unbind("click",unmark).click(function(){mark(a)})});return true}function mark(a){var b=$("#bookmark_selector option:selected").val();var c=localStorage.getItem(b);var d=c===null?[]:c.split("+");if(d.length>=100){alert("お気に入りに登録できる動画は 100 個までです。");return false}d.push(a);var e=$("li[title='"+a+"']:first img");var f=e.attr("alt");f.replace("+","＋");var g=e.attr("src");localStorage.setItem(b,d.join("+"));localStorage.setItem(a,[f,g].join("+"));$("li[title='"+a+"'] a.mark_button").each(function(){$(this).text("★").unbind("click",mark).click(function(){unmark(a)})});$("#marked_list").append(frameMarkedItem(a,f,g,b));return true}function previewMovieDetail(a){if($("#movie_detail").is(":visible")){$("#movie_detail").hide(300);return false}$.ajax({type:"GET",url:"http://www.cafe-gentle.jp/cgi-bin/nico/ranking_collection.cgi",dataType:"xml",data:"movieID="+a,success:function(a){var b=$(a);window_height=$(window).height();min_height=Math.min(window_height-100,600);$("#movie_detail_title").text(b.find("title").text());$("#movie_detail_first_retrieve").text(b.find("first_retrieve").text());$("#movie_detail_length").text(b.find("length").text());$("#movie_detail_view").text(b.find("view_counter").text());$("#movie_detail_res").text(b.find("comment_num").text());$("#movie_detail_mylist").text(b.find("mylist_counter").text());$("#movie_detail_tags").text(b.find("tags").text());$("#movie_detail_last_res_body").text(b.find("last_res_body").text());$("#movie_detail_description").text(b.find("description").text());$("#movie_detail_thumbnail").find("img").attr("src",b.find("thumbnail_url").text());$("#movie_detail").height(min_height).show(300)},error:function(){alert("通信エラーが発生しました。")}});return false}function displaySaveData(){$("#rink").children().not("#bookmark").remove();$("#shelf").empty();var a=load();for(var b=-1,c=a.length;++b<c;){var d=a[b].split("-");var e=d[0];var f={key:e};if(e=="ranking"){f["type"]=d[1];f["range"]=d[2];f["genre"]=d[3]}else if(e=="new"){f["genre"]=d[1]}else if(e=="tag"){f["tag_name"]=d[1];f["sort_by"]=d[2]}else if(e=="open_mylist"){f["open_mylist_num"]=d[1]}requestRSS(f)}return false}function save(){var a=$("#save_selector .selected").attr("id");var b=[];$("#rink").children().not("#bookmark").each(function(){b.push($(this).attr("id"))});localStorage.setItem(a,b.join("+"));return false}function load(){var a=$("#save_selector .selected").attr("id");var b=localStorage.getItem(a);return b===null?[]:b.split("+")}function filterOut(a,b,c,d,e){var f=$("#view_ou").val();var g=$("#res_ou").val();var h=$("#mylist_ou").val();$("li.ranking-item").each(function(){var i=$(this).find(".nico-info-total-view").text().replace(/,/g,"")-0;var j=$(this).find(".nico-info-total-res").text().replace(/,/g,"")-0;var k=$(this).find(".nico-info-total-mylist").text().replace(/,/g,"")-0;if(!(compare(i,a,f)&&compare(j,b,g)&&compare(k,c,h))){$(this).hide()}var l=$(this).find(".nico-info-date").text();if(!isInPeriod(l,d)){$(this).hide()}var m=$(this).find(".movie_title").text();var n=$(this).find(".nico-description").text();if(m.indexOf(e)==-1&&n.indexOf(e)==-1){$(this).hide()}});return false}function isInPeriod(a,b){if(b===0){return true}var c=new Date;c.setTime(c.getTime()-b*24*3600*1e3);var d=c.getFullYear();var e=c.getMonth()+1;var f=c.getDate();e=e<10?"0"+e:e;f=f<10?"0"+f:f;var g=d+"年"+e+"月"+f+"日";return a>g}function compare(a,b,c){if(c=="over"){return a>=b}else{return a<b}}function stackRanking(a,b){var c=document;var d=$(c.createElement("span"));d.addClass(a).text(b).append($(c.createElement("span")).addClass("close").click(function(){a=a.replace(/([ \@#;&,.%+*~\':"!^$[\]()=>|\/])/g,"\\$1");$("."+a).remove();save()}));$("#shelf").append(d);return false}function makeRankingTitle(a){var b=a["key"];if(b=="ranking"){return[{view:"再生",res:"コメント",mylist:"マイリスト",fav:"総合"}[a["type"]],{hourly:"毎時",daily:"デイリー",weekly:"週間",monthly:"月間",total:"合計"}[a["range"]],{all:"総合",ent:"エンタメ",music:"音楽",sing:"歌ってみた",play:"演奏してみた",dance:"踊ってみた",vocaloid:"VOCALOID",nicoindies:"インディーズ",animal:"動物",cooking:"料理",nature:"自然",travel:"旅行",sport:"スポーツ",lecture:"ニコ動講座",drive:"車載動画",history:"歴史",politics:"政治",science:"科学",tech:"技術部",handcraft:"手芸部",make:"作ってみた",anime:"アニメ",game:"ゲーム",toho:"東方",imas:"IM@S",radio:"ラジオ",draw:"描いてみた",are:"例のアレ",diary:"日記",other:"その他"}[a["genre"]]].join("-")}else if(b=="new"){return{newarrival:"新着投稿動画",recent:"新着コメント動画"}[a["genre"]]}else if(b=="tag"){return a["tag_name"]}else if(b=="open_mylist"){return"マイリストID: "+a["open_mylist_num"]}}function makeRankingURL(a){var b="http://www.nicovideo.jp/";var c=a["key"];if(c=="ranking"){b+=["ranking",a["type"],a["range"],a["genre"]].join("/")}else if(c=="new"){b+=a["genre"]}else if(c=="tag"){b+="tag/"+a["tag_name"]+"?sort="+a["sort_by"]}else if(c=="open_mylist"){b+=["mylist",a["open_mylist_num"]].join("/")}return b}function makeRID(a){var b=a["key"];if(b=="ranking"){return[b,a["type"],a["range"],a["genre"]].join("-")}else if(b=="new"){return[b,a["genre"]].join("-")}else if(b=="tag"){return[b,a["tag_name"],a["sort_by"]].join("-")}else if(b=="open_mylist"){return[b,a["open_mylist_num"]].join("-")}}function requestRSS(a){var b=$("#rink").children();if(b.length>6){alert("1 つのセーブ枠に、セーブできる項目数は 6 個です。");return false}var c=makeRID(a);if(b.is("."+c)){return false}var d=makeRankingURL(a);var e=insertFrame(a);if(a["key"]=="tag"){var f=new google.feeds.Feed(d+"&rss=2.0")}else{var f=new google.feeds.Feed(d+"?rss=2.0")}f.setNumEntries(100);f.setResultFormat(google.feeds.Feed.XML_FORMAT);f.load(function(a){if(!a.error){e.children(":last").remove();var b=a.xmlDocument.getElementsByTagName("item");if(b.length>1){e.append(frameBody(b));save()}else{e.append('<p class="loading">指定されたタグは存在しません。</p>')}}else{$("."+c).remove()}});return true}jQuery(function(a){a("#clear").click(function(){a("#rink section").not("#bookmark").remove();a("#shelf").empty();save()});a("#movie_detail").click(function(){a("#movie_detail").hide(300)});a("#query").keydown(function(b){if(b.keyCode==13){location.href="http://www.nicovideo.jp/search/"+a("#query").val()}});a("#remocon_toggle").click(function(){a("#remocon").toggle(300);a("#filter").hide()});a("#filter_toggle").click(function(){a("#filter").toggle(300);a("#remocon").hide()});a("#tag_name").keydown(function(b){if(b.keyCode==13){a("#tag_ret").focus()}});a("#view,#res,#mylist,#comment").keydown(function(b){if(b.keyCode==13){a("#filter_ret").focus()}});a("#range").change(function(){if(a(this).val()=="hourly"){a("#genre").children("button").not("#g_all").hide()}else{a("#genre").children("button").show()}});a("#genre").children("button").click(function(){requestRSS({key:"ranking",type:a("#type").val(),range:a("#range").val(),genre:a(this).val()})});a("#new").children("button").click(function(){requestRSS({key:"new",genre:a(this).val()})});a("#tag_ret").click(function(){requestRSS({key:"tag",tag_name:a("#tag_name").val(),sort_by:a("#sort_by").val()})});a("#open_mylist_ret").click(function(){requestRSS({key:"open_mylist",open_mylist_num:a("#open_mylist_num").val()})});a("#filter_ret").click(function(){var b=a("#view").val()-0;var c=a("#res").val()-0;var d=a("#mylist").val()-0;var e=a("#period").val().split("_").pop()-0;var f=jQuery.trim(a("#comment").val());if(isNaN(b)||isNaN(c)||isNaN(d)){a('<span class="quick-alert">正しい数値を入力してください。</span>').insertAfter(a(this)).fadeIn("slow").animate({opacity:1},3e3).fadeOut("slow",function(){a(this).remove()})}else{a("li.ranking-item").show();filterOut(b,c,d,e,f)}});a("#filter_clr").click(function(){a("li.ranking-item").show();a("#view, #res, #mylist").val(0);a("#period").val("day_0");a("#comment").val("")});a("#save_selector li").click(function(){if(a(this).hasClass("selected")){return true}a("#save_selector .selected").removeClass("selected");a(this).addClass("selected");displaySaveData()});a("#bookmark_selector").change(function(){displayBookmark()});a("#range").val("daily");importBookmark();displaySaveData();displayBookmark()})
